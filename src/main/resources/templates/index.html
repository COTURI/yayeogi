<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>항공권 검색</title>
    <link rel="stylesheet" href="/css/index.css">
</head>
<body>

<h1>항공권 검색</h1>
<div class="search-container">
    <div class="search-form">
        <label for="origin">출발지:</label>
        <input type="text" id="origin" oninput="updateSuggestions('origin')">
        <div id="origin-suggestions" class="suggestions"></div>
    </div>

    <div class="search-form">
        <label for="destination">도착지:</label>
        <input type="text" id="destination" oninput="updateSuggestions('destination')">
        <div id="destination-suggestions" class="suggestions"></div>
    </div>

    <div class="search-form">
        <label for="departureDate">출발일:</label>
        <input type="date" id="departureDate">
    </div>

    <div class="search-form">
        <label for="adults">성인 수:</label>
        <input type="number" id="adults" min="1" value="1">
    </div>

    <button class="search-button" onclick="searchFlights()">항공권 검색</button>
    <div id="results"></div>
    <div id="pagination-controls" class="pagination-controls"></div>
</div>

<script>
    let airports = {};
    let airlines = {};
    let currentPage = 1;
    const resultsPerPage = 10;

    async function loadData() {
        try {
            const airportResponse = await fetch('/js/airports.json');
            const airlineResponse = await fetch('/js/airlines.json');

            if (!airportResponse.ok || !airlineResponse.ok) {
                throw new Error('데이터를 불러오는 데 문제가 발생했습니다.');
            }

            airports = await airportResponse.json();
            airlines = await airlineResponse.json();
        } catch (error) {
            console.error('데이터 불러오기 오류:', error);
        }
    }

    function updateSuggestions(inputId) {
        const inputElement = document.getElementById(inputId);
        const suggestionsElement = document.getElementById(inputId + '-suggestions');
        const query = inputElement.value.toLowerCase();
        suggestionsElement.innerHTML = '';

        if (query.length > 1) {
            const suggestions = Object.entries(airports).filter(([code, name]) =>
                name.toLowerCase().includes(query) || code.toLowerCase().includes(query)
            );
            suggestions.forEach(([code, name]) => {
                const item = document.createElement('div');
                item.classList.add('suggestion-item');
                item.textContent = `${name} (${code})`;
                item.onclick = () => {
                    inputElement.value = name;
                    suggestionsElement.innerHTML = '';
                };
                suggestionsElement.appendChild(item);
            });
        }
    }

    function convertEuroToWon(euroAmount) {
        const exchangeRate = 1500; // 1 Euro = 1500 KRW
        return euroAmount * exchangeRate;
    }

    async function searchFlights() {
    const originInput = document.getElementById('origin').value;
    const destinationInput = document.getElementById('destination').value;
    const departureDate = document.getElementById('departureDate').value;
    const adults = document.getElementById('adults').value;

    // Convert the input values to uppercase for comparison
    const origin = originInput.toUpperCase();
    const destination = destinationInput.toUpperCase();

    try {
        // Find the airport codes for the input values
        const originCode = Object.keys(airports).find(code => airports[code].toUpperCase() === origin) || origin;
        const destinationCode = Object.keys(airports).find(code => airports[code].toUpperCase() === destination) || destination;

        // Fetch flights data from the API
        const response = await fetch(`/flights?origin=${originCode}&destination=${destinationCode}&departureDate=${departureDate}&adults=${adults}`);
        if (!response.ok) {
            throw new Error(`HTTP 오류! 상태: ${response.status}`);
        }
        const data = await response.json();

        console.log('API response data:', data); // Debugging

        // Filter out flights that don't match the input origin and destination
        const filteredFlights = data.filter(flight => {
            return flight.itineraries.some(itinerary => {
                return itinerary.segments.some(segment => {
                    const departureAirportCode = segment.departure.iataCode.toUpperCase();
                    const arrivalAirportCode = segment.arrival.iataCode.toUpperCase();
                    return departureAirportCode === originCode && arrivalAirportCode === destinationCode;
                });
            });
        });

        // Check if there are any filtered flights
        if (filteredFlights.length > 0) {
            let resultHtml = '<h3>검색 결과:</h3>';
            filteredFlights.forEach(flight => {
                if (flight.itineraries && flight.itineraries.length > 0) {
                    flight.itineraries.forEach(itinerary => {
                        if (itinerary.segments && itinerary.segments.length > 0) {
                            itinerary.segments.forEach(segment => {
                                const carrierCode = segment.carrierCode ? segment.carrierCode.toUpperCase() : '알 수 없음';
                                const airlineName = airlines[carrierCode] || '알 수 없음';

                                const departureAirportCode = segment.departure.iataCode || '알 수 없음';
                                const arrivalAirportCode = segment.arrival.iataCode || '알 수 없음';

                                const departureAirport = airports[departureAirportCode] || departureAirportCode;
                                const arrivalAirport = airports[arrivalAirportCode] || arrivalAirportCode;

                                // Convert price to KRW if it's in EUR
                                const priceInKRW = flight.price.currency === 'EUR' ? convertEuroToWon(parseFloat(flight.price.total)) : parseFloat(flight.price.total);
                                const priceCurrency = flight.price.currency === 'EUR' ? 'KRW' : flight.price.currency;

                                resultHtml += `
                                    <div class="result-item">
                                        <p><strong>항공사:</strong> ${airlineName}</p>
                                        <p><strong>출발:</strong> ${departureAirport} (${segment.departure.at})</p>
                                        <p><strong>도착:</strong> ${arrivalAirport} (${segment.arrival.at})</p>
                                        <p><strong>가격:</strong> ${priceInKRW.toLocaleString()} ${priceCurrency}</p>
                                        <a href="/detail?origin=${originCode}&destination=${destinationCode}&departureDate=${departureDate}&adults=${adults}&carrierCode=${carrierCode}&departureAirport=${departureAirportCode}&arrivalAirport=${arrivalAirportCode}&price=${priceInKRW}&currency=${priceCurrency}" target="_blank">상세보기</a>
                                    </div>
                                `;
                            });
                        }
                    });
                }
            });
            document.getElementById('results').innerHTML = resultHtml;
        } else {
            document.getElementById('results').innerHTML = '<p>검색 결과가 없습니다.</p>';
        }
    } catch (error) {
        document.getElementById('results').innerHTML = `<p>오류가 발생했습니다: ${error.message}</p>`;
        document.getElementById('pagination-controls').innerHTML = '';
    }
}

    function updatePaginationControls(currentPage, totalPages) {
        const paginationControls = document.getElementById('pagination-controls');
        let paginationHtml = '';

        if (totalPages > 1) {
            if (currentPage > 1) {
                paginationHtml += `<button onclick="changePage(${currentPage - 1})">이전</button>`;
            }

            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `<button class="${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }

            if (currentPage < totalPages) {
                paginationHtml += `<button onclick="changePage(${currentPage + 1})">다음</button>`;
            }
        }

        paginationControls.innerHTML = paginationHtml;
    }

    function changePage(pageNumber) {
        currentPage = pageNumber;
        searchFlights();
    }

    // 초기 데이터 로드
    loadData();
</script>

</body>
</html>
